<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>インデックスラベル印刷 (空白ページ修正版)</title>
<style>
    /* --- 設定変数 --- */
    :root {
        --mirror-dist: 6.1mm; 
        --offset-x: 0mm;
        --offset-y: 0mm;
        --cell-w: 31.5mm; 
        --cell-h: 24.8mm;
        --margin-top: 2.2mm;   
        --margin-right: 5.65mm;
        --base-font-size: 3.3mm;
    }

    /* --- UIスタイル --- */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #eef2f6; margin: 0; padding: 0; color: #333; }
    
    /* コントロールバー */
    #controls {
        background: #fff; border-bottom: 1px solid #ddd; padding: 12px 20px;
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
    }
    
    .control-group { display: flex; align-items: center; gap: 8px; }
    .divider { height: 24px; width: 1px; background: #ddd; margin: 0 5px; }
    
    button { 
        padding: 8px 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; 
        font-weight: 600; background: #fff; color: #444; font-size: 0.85rem; transition: 0.2s; 
    }
    button:hover { background: #f5f5f5; border-color: #bbb; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.success { background: #28a745; color: white; border-color: #28a745; }

    input[type="number"] { width: 60px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; text-align: right; font-size: 0.9rem; }
    label { font-size: 0.85rem; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .unit { font-size: 0.8rem; color: #888; }

    /* --- プレビューエリア --- */
    #previewArea {
        padding: 40px; min-height: calc(100vh - 80px);
        display: flex; justify-content: center; flex-direction: column; align-items: center;
    }

    /* --- 用紙設定 (A4 Landscape) --- */
    @page { 
        size: A4 landscape; 
        margin: 0; /* ブラウザのヘッダーフッター余白をゼロに */
    }
    
    .sheet {
        width: 297mm; height: 210mm; background: white;
        position: relative; overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 40px;
    }

    /* グリッド */
    .grid-container {
        position: absolute;
        top: calc(var(--margin-top) + var(--offset-y));
        right: calc(var(--margin-right) - var(--offset-x));
        width: calc(var(--cell-w) * 9);
        height: calc(var(--cell-h) * 8);
        display: grid;
        direction: rtl; 
        grid-template-columns: repeat(9, var(--cell-w));
        grid-template-rows: repeat(8, var(--cell-h));
        grid-auto-flow: column; 
    }

    .cell {
        width: var(--cell-w); height: var(--cell-h);
        position: relative;
        border: 0.5px dotted #eee;
        box-sizing: border-box;
        display: flex; justify-content: center; align-items: center;
    }
    .cell:hover { background-color: #f0f7ff; cursor: text; }

    /* テキスト配置 */
    .center-axis { position: relative; width: 0; height: 0; }
    
    .label-text-wrapper {
        position: absolute; top: 0;
        transform: translate(-50%, -50%);
        writing-mode: vertical-rl; text-orientation: upright;
        white-space: pre; 
        font-family: "HeiseiMin-W3", "Hiragino Mincho ProN", "Yu Mincho", serif;
        font-size: var(--base-font-size);
        line-height: 1.0;
        outline: none; min-width: 1em; min-height: 1em; text-align: center;
    }
    .label-text-wrapper:focus { background: #e8f0fe; z-index: 10; border-radius: 2px; }

    .text-plus { left: var(--mirror-dist); }
    .text-minus { left: calc(var(--mirror-dist) * -1); }

    /* --- モーダル --- */
    #modalOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(2px);
    }
    #modalContent {
        background: white; width: 90%; max-width: 800px; max-height: 85vh;
        border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #modalHeader { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .table-wrapper { overflow: auto; border: 1px solid #e0e0e0; margin-bottom: 15px; flex-grow: 1; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
    th, td { border: 1px solid #eee; padding: 8px 12px; text-align: left; }
    th.selectable-col { cursor: pointer; background: #f9fafb; position: sticky; top: 0; z-index: 1; border-bottom: 2px solid #ddd; }
    th.selected-col { background: #e3f2fd; border-bottom: 2px solid #007bff; color: #0056b3; }
    tr.is-header { opacity: 0.5; background: #f5f5f5; }

    /* --- 印刷時スタイル (修正箇所) --- */
    @media print {
        body, html { 
            width: 100%; height: auto; margin: 0; padding: 0; background: white; 
        }
        
        /* UI非表示 */
        #controls, #modalOverlay { display: none !important; }
        
        /* コンテナリセット */
        #previewArea { 
            padding: 0 !important; margin: 0 !important; background: white; 
            display: block !important; /* flex解除 */
            height: auto !important;
        }
        
        /* シート設定 */
        .sheet { 
            margin: 0 !important; 
            box-shadow: none !important; 
            border: none !important; 
            overflow: hidden !important; 
            
            /* 通常は改ページする */
            page-break-after: always !important;
            break-after: page !important;
        }
        
        /* ★重要: 最後のシートだけは改ページしない */
        .sheet:last-child { 
            page-break-after: auto !important;
            break-after: auto !important;
            margin-bottom: 0 !important;
        }
        
        /* 罫線など除去 */
        .cell { border: none !important; background: none !important; }
        .label-text-wrapper { background: none !important; }
    }
</style>
</head>
<body>

<div id="controls">
    <div class="control-group">
        <button class="primary" onclick="document.getElementById('csvFile').click()">CSV読込</button>
        <input type="file" id="csvFile" accept=".csv" onchange="openModalFromFile(this)" style="display:none;">
        <button onclick="openModalWithSample()">サンプル</button>
        <button onclick="clearAll()">クリア</button>
    </div>

    <div class="divider"></div>

    <div class="control-group">
        <label title="片方を編集すると裏面も自動更新します"><input type="checkbox" id="syncCheck" checked> 両面同期</label>
        <label style="margin-left:10px;">開始位置 <input type="number" id="startPos" value="0" min="0" onchange="render()"></label>
    </div>

    <div class="divider"></div>

    <div class="control-group">
        <label>中心距離 <input type="number" id="distInput" value="6.1" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
        <label style="margin-left:10px;">X補正 <input type="number" id="xInput" value="0.0" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
        <label style="margin-left:5px;">Y補正 <input type="number" id="yInput" value="0.0" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
    </div>

    <div style="flex-grow: 1;"></div>

    <div class="control-group">
        <button class="success" onclick="window.print()">印刷</button>
    </div>
</div>

<div id="previewArea"></div>

<div id="modalOverlay">
    <div id="modalContent">
        <div id="modalHeader">
            <span>読込設定</span>
            <button onclick="closeModal()" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">✕</button>
        </div>
        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 15px;">
            <label><input type="checkbox" id="hasHeader" checked onchange="updateModalTable()"> 1行目は見出し</label>
            <span style="font-size: 0.85rem; color: #666;">※列ヘッダをクリックして印刷対象を選択</span>
        </div>
        <div class="table-wrapper"><table id="previewTable"></table></div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: auto;">
            <button onclick="closeModal()">キャンセル</button>
            <button class="primary" onclick="confirmImport()">決定</button>
        </div>
    </div>
</div>

<script>
let rawCSVData = [];
let selectedColIndex = 1;
let processedList = [];
const rows = 9; const cols = 8;
const BASE_SIZE_MM = 3.3; 

window.onload = function() { };

function updateStyles() {
    const root = document.documentElement;
    root.style.setProperty('--mirror-dist', document.getElementById('distInput').value + 'mm');
    root.style.setProperty('--offset-x', document.getElementById('xInput').value + 'mm');
    root.style.setProperty('--offset-y', document.getElementById('yInput').value + 'mm');
}

function openModalFromFile(input) {
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        rawCSVData = parseCSV(e.target.result);
        selectedColIndex = 1; 
        if (rawCSVData.length > 0 && rawCSVData[0].length <= 1) selectedColIndex = 0;
        showModal();
        input.value = ''; 
    };
    reader.readAsText(input.files[0]);
}

function openModalWithSample() {
    const sample = "ID,科目名,備考\n1,現金,資産\n2,当座\n預金,資産\n3,普通\n預金,資産\n4,受取\n手形,資産\n5,売掛金,資産\n6,棚卸\n資産,資産\n7,前払\n費用,資産\n8,建物,固定資産\n9,減価償却\n累計額,マイナス資産";
    rawCSVData = parseCSV(sample);
    selectedColIndex = 1;
    document.getElementById('hasHeader').checked = true;
    showModal();
}

function showModal() {
    document.getElementById('modalOverlay').style.display = 'flex';
    updateModalTable();
}

function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
}

function updateModalTable() {
    const table = document.getElementById('previewTable');
    table.innerHTML = "";
    if (rawCSVData.length === 0) return;
    const hasHeader = document.getElementById('hasHeader').checked;
    const maxRows = Math.min(rawCSVData.length, 50); 
    const colCount = rawCSVData.reduce((max, row) => Math.max(max, row.length), 0);
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    for (let c = 0; c < colCount; c++) {
        const th = document.createElement('th');
        th.className = 'selectable-col';
        if (c === selectedColIndex) th.classList.add('selected-col');
        th.textContent = `列 ${c + 1}`;
        th.onclick = () => { selectedColIndex = c; updateModalTable(); };
        headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for (let r = 0; r < maxRows; r++) {
        const tr = document.createElement('tr');
        if (r === 0 && hasHeader) tr.className = 'is-header';
        for (let c = 0; c < colCount; c++) {
            const td = document.createElement('td');
            let text = rawCSVData[r][c] || "";
            text = text.replace(/\\n/g, '⏎').replace(/\n/g, '⏎');
            td.textContent = text;
            if (c === selectedColIndex) td.classList.add('selected-col-cell');
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
}

function confirmImport() {
    const hasHeader = document.getElementById('hasHeader').checked;
    processedList = [];
    rawCSVData.forEach((row, index) => {
        if (hasHeader && index === 0) return;
        if (row.length > selectedColIndex) {
            let val = row[selectedColIndex];
            val = val.replace(/\\n/g, '\n'); 
            if (val.trim() !== "") processedList.push(val);
        }
    });
    render();
    closeModal();
}

function clearAll() {
    processedList = [];
    render();
}

function parseCSV(text) {
    return text.split(/\r\n|\n|\r/).map(line => {
        return line.split(',').map(c => c.replace(/^"|"$/g, '').trim());
    }).filter(row => row.length > 1 || (row.length === 1 && row[0] !== ""));
}

function updateFontSize(element, text) {
    if (!text) { element.style.fontSize = `${BASE_SIZE_MM}mm`; return; }
    const lines = text.split(/\r\n|\n|\r/);
    let maxLen = 0;
    lines.forEach(line => { if (line.length > maxLen) maxLen = line.length; });
    let size = BASE_SIZE_MM;
    if (maxLen > 5) { size = BASE_SIZE_MM * 5 / maxLen; }
    element.style.fontSize = `${size}mm`;
}

function handleInput(e) {
    const target = e.target;
    const parent = target.parentElement; 
    const isPlus = target.classList.contains('text-plus');
    const text = target.innerText;
    updateFontSize(target, text);
    if (document.getElementById('syncCheck').checked) {
        const pair = isPlus ? parent.querySelector('.text-minus') : parent.querySelector('.text-plus');
        if (pair) {
            pair.innerText = text;
            updateFontSize(pair, text);
        }
    }
}

function render() {
    const container = document.getElementById('previewArea');
    container.innerHTML = "";
    const startPos = parseInt(document.getElementById('startPos').value) || 0;
    const itemsPerPage = rows * cols; 
    const totalNeeded = startPos + processedList.length;
    const pageCount = Math.max(1, Math.ceil(totalNeeded / itemsPerPage));
    let dataIndex = 0;

    for (let p = 0; p < pageCount; p++) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        const grid = document.createElement('div');
        grid.className = 'grid-container';
        for (let i = 0; i < itemsPerPage; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            let initialText = "";
            if (i >= startPos && dataIndex < processedList.length) {
                initialText = processedList[dataIndex];
                dataIndex++;
            }
            const anchor = document.createElement('div');
            anchor.className = 'center-axis';
            const textPlus = document.createElement('div');
            textPlus.className = 'label-text-wrapper text-plus';
            textPlus.contentEditable = true; 
            textPlus.innerText = initialText;
            const textMinus = document.createElement('div');
            textMinus.className = 'label-text-wrapper text-minus';
            textMinus.contentEditable = true;
            textMinus.innerText = initialText;
            updateFontSize(textPlus, initialText);
            updateFontSize(textMinus, initialText);
            textPlus.addEventListener('input', handleInput);
            textMinus.addEventListener('input', handleInput);
            cell.onclick = function(e) { if (e.target === cell) textPlus.focus(); };
            anchor.appendChild(textPlus);
            anchor.appendChild(textMinus);
            cell.appendChild(anchor);
            grid.appendChild(cell);
        }
        sheet.appendChild(grid);
        container.appendChild(sheet);
    }
}
</script>
</body>
</html>
