<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ«ä½œæˆ Master (æ”¹è¡Œå¯¾å¿œç‰ˆ)</title>
<style>
    /* --- è¨­å®šå¤‰æ•° --- */
    :root {
        --mirror-dist: 6.1mm; 
        --offset-x: 0mm;
        --offset-y: 0mm;
        --cell-w: 31.5mm; 
        --cell-h: 24.8mm;
        --margin-top: 2.2mm;   
        --margin-right: 5.65mm;
        --base-font-size: 3.3mm;
    }

    /* --- UIã‚¹ã‚¿ã‚¤ãƒ« --- */
    body { font-family: sans-serif; background: #eef2f6; margin: 0; padding: 0; color: #333; }
    
    #controls {
        background: #fff; border-bottom: 1px solid #ddd; padding: 10px 20px;
        position: sticky; top: 0; z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
    }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .divider { height: 24px; width: 1px; background: #ddd; margin: 0 5px; }
    
    button { 
        padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; 
        font-weight: 600; background: #fff; color: #444; font-size: 0.85rem; transition: 0.2s; 
    }
    button:hover { background: #f5f5f5; }
    button.primary { background: #007bff; color: white; border-color: #007bff; }
    button.primary:hover { background: #0056b3; }
    button.success { background: #28a745; color: white; border-color: #28a745; }
    button.danger { background: #dc3545; color: white; border-color: #dc3545; }

    input[type="number"] { width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; text-align: right; }
    label { font-size: 0.85rem; font-weight: bold; color: #555; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .unit { font-size: 0.8rem; color: #888; }

    /* --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ --- */
    #previewArea {
        padding: 40px; min-height: calc(100vh - 100px);
        display: flex; justify-content: center; flex-direction: column; align-items: center;
        user-select: none; 
    }

    /* --- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    #contextMenu {
        display: none; position: absolute; z-index: 1000;
        background: white; border: 1px solid #ccc; border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 5px 0; min-width: 150px;
    }
    #contextMenu div { padding: 8px 15px; cursor: pointer; font-size: 0.9rem; }
    #contextMenu div:hover { background: #f0f0f0; }
    #contextMenu .menu-danger { color: #dc3545; }

    /* --- ç”¨ç´™è¨­å®š --- */
    @page { size: A4 landscape; margin: 0; }
    
    .sheet {
        width: 297mm; height: 210mm; background: white;
        position: relative; overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 40px;
    }

    .grid-container {
        position: absolute;
        top: calc(var(--margin-top) + var(--offset-y));
        right: calc(var(--margin-right) - var(--offset-x));
        width: calc(var(--cell-w) * 9); height: calc(var(--cell-h) * 8);
        display: grid; direction: rtl; 
        grid-template-columns: repeat(9, var(--cell-w));
        grid-template-rows: repeat(8, var(--cell-h));
        grid-auto-flow: column; 
    }

    .cell {
        width: var(--cell-w); height: var(--cell-h);
        position: relative; border: 0.5px dotted #eee;
        box-sizing: border-box; display: flex; justify-content: center; align-items: center;
    }
    .cell:hover { background-color: #f0f7ff; cursor: context-menu; }
    .cell.active-target { background-color: #e3f2fd; } 

    /* ãƒ†ã‚­ã‚¹ãƒˆé…ç½® */
    .center-axis { position: relative; width: 0; height: 0; }
    .label-text-wrapper {
        position: absolute; top: 0; transform: translate(-50%, -50%);
        writing-mode: vertical-rl; text-orientation: upright;
        white-space: pre; 
        font-family: "HeiseiMin-W3", "Hiragino Mincho ProN", "Yu Mincho", serif;
        font-size: var(--base-font-size); line-height: 1.0;
        outline: none; min-width: 1em; min-height: 1em; text-align: center;
    }
    .label-text-wrapper:focus { background: #e8f0fe; z-index: 10; cursor: text; }
    .text-plus { left: var(--mirror-dist); }
    .text-minus { left: calc(var(--mirror-dist) * -1); }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒªã‚¹ãƒˆç·¨é›†ç”¨) --- */
    #editModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        display: none; align-items: center; justify-content: center;
    }
    #editModalContent {
        background: white; width: 90%; max-width: 600px; max-height: 80vh;
        border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .list-editor {
        flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; margin: 10px 0;
    }
    .list-row {
        display: flex; border-bottom: 1px solid #eee; padding: 5px; align-items: start; /* ä¸Šæƒãˆã«å¤‰æ›´ */
    }
    .list-row:nth-child(even) { background: #f9f9f9; }
    .list-idx { width: 40px; color: #888; font-size: 0.8rem; text-align: center; padding-top: 8px; }
    
    /* Textareaã«å¤‰æ›´ */
    .list-input { 
        flex-grow: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; 
        font-family: inherit; resize: vertical; min-height: 38px;
    }
    .list-del { margin-left: 10px; color: #dc3545; cursor: pointer; padding: 8px; }

    /* --- å°åˆ·æ™‚ --- */
    @media print {
        body, html { width: 100%; height: 100%; margin: 0; background: white; }
        #controls, #contextMenu, #editModal { display: none !important; }
        #previewArea { padding: 0 !important; margin: 0 !important; background: white; display: block !important; height: auto !important; }
        .sheet { margin: 0 !important; box-shadow: none; border: none; overflow: hidden; page-break-after: always; break-after: page; }
        .sheet:last-child { page-break-after: auto; break-after: auto; }
        .cell { border: none; background: none !important; }
        .label-text-wrapper { background: none !important; }
    }
</style>
</head>
<body>

<div id="controls">
    <div class="control-group">
        <button class="primary" onclick="openEditModal()">ğŸ“ ãƒªã‚¹ãƒˆç·¨é›†</button>
        <button onclick="document.getElementById('csvFile').click()">CSVèª­è¾¼</button>
        <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(this)" style="display:none;">
        <button onclick="loadSample()">ã‚µãƒ³ãƒ—ãƒ«</button>
        <button onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="divider"></div>

    <div class="control-group">
        <label><input type="checkbox" id="syncCheck" checked> ä¸¡é¢åŒæœŸ</label>
        <label style="margin-left:10px;">é–‹å§‹ä½ç½® <input type="number" id="startPos" value="0" min="0" onchange="render()"></label>
    </div>

    <div class="divider"></div>

    <div class="control-group">
        <label>ä¸­å¿ƒ <input type="number" id="distInput" value="6.1" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
        <label>X <input type="number" id="xInput" value="0.0" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
        <label>Y <input type="number" id="yInput" value="0.0" step="0.1" onchange="updateStyles()"></label><span class="unit">mm</span>
    </div>

    <div style="flex-grow: 1;"></div>

    <div class="control-group">
        <button class="success" onclick="window.print()">ğŸ–¨ å°åˆ·</button>
    </div>
</div>

<div id="previewArea"></div>

<div id="contextMenu">
    <div onclick="menuAction('insert')">â¤µ 1ã¤æŒ¿å…¥ (å¾Œã‚ã¸é€ã‚‹)</div>
    <div onclick="menuAction('pagebreak')">ğŸ“„ æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸é€ã‚‹</div>
    <div onclick="menuAction('delete')" class="menu-danger">ğŸ—‘ 1ã¤å‰Šé™¤ (å‰ã¸è©°ã‚ã‚‹)</div>
    <div onclick="menuAction('clear')">âœ• æ–‡å­—æ¶ˆå» (è©°ã‚ãªã„)</div>
</div>

<div id="editModal">
    <div id="editModalContent">
        <div style="font-weight:bold; font-size:1.1rem; margin-bottom:10px;">ãƒªã‚¹ãƒˆç·¨é›†</div>
        <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">Enterã‚­ãƒ¼ã§æ”¹è¡Œã§ãã¾ã™ã€‚</div>
        
        <div class="list-editor" id="listEditorBody"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="addListRow()">ï¼‹ è¡Œè¿½åŠ </button>
            <div style="flex-grow:1"></div>
            <button onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="primary" onclick="saveListEdit()">åæ˜ ã™ã‚‹</button>
        </div>
    </div>
</div>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
let labelData = []; // æ–‡å­—åˆ—ã®é…åˆ— (ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿)
let contextTargetIndex = -1; 
const rows = 9; const cols = 8;
const itemsPerPage = rows * cols; // 72
const BASE_SIZE_MM = 3.3; 

window.onload = function() {
    document.addEventListener('click', function(e) {
        document.getElementById('contextMenu').style.display = 'none';
        document.querySelectorAll('.active-target').forEach(el => el.classList.remove('active-target'));
    });
};

function updateStyles() {
    const root = document.documentElement;
    root.style.setProperty('--mirror-dist', document.getElementById('distInput').value + 'mm');
    root.style.setProperty('--offset-x', document.getElementById('xInput').value + 'mm');
    root.style.setProperty('--offset-y', document.getElementById('yInput').value + 'mm');
}

// --- å³ã‚¯ãƒªãƒƒã‚¯å‡¦ç† ---
function showContextMenu(e, index) {
    e.preventDefault();
    contextTargetIndex = index;
    document.querySelectorAll('.active-target').forEach(el => el.classList.remove('active-target'));
    e.currentTarget.classList.add('active-target');

    const menu = document.getElementById('contextMenu');
    menu.style.display = 'block';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
}

function menuAction(action) {
    if (contextTargetIndex === -1) return;
    const startPos = parseInt(document.getElementById('startPos').value) || 0;
    let dataIdx = contextTargetIndex - startPos;

    if (action === 'insert') {
        ensureArrayLength(dataIdx);
        labelData.splice(dataIdx, 0, "");
    } 
    else if (action === 'delete') {
        if (dataIdx >= 0 && dataIdx < labelData.length) {
            labelData.splice(dataIdx, 1);
        }
    }
    else if (action === 'clear') {
        ensureArrayLength(dataIdx);
        labelData[dataIdx] = "";
    }
    else if (action === 'pagebreak') {
        const nextPageStart = Math.floor(contextTargetIndex / itemsPerPage + 1) * itemsPerPage;
        const spacesNeeded = nextPageStart - contextTargetIndex;
        ensureArrayLength(dataIdx);
        for(let k=0; k<spacesNeeded; k++) {
            labelData.splice(dataIdx, 0, "");
        }
    }
    render();
}

function ensureArrayLength(targetIdx) {
    if (targetIdx < 0) return;
    while (labelData.length <= targetIdx) labelData.push("");
}

// --- ãƒªã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (ä¿®æ­£ç®‡æ‰€: TextareaåŒ–) ---
function openEditModal() {
    const body = document.getElementById('listEditorBody');
    body.innerHTML = "";
    
    labelData.forEach((text, i) => {
        addListRowUI(body, i, text);
    });
    if(labelData.length === 0) addListRowUI(body, 0, "");

    document.getElementById('editModal').style.display = 'flex';
}

function addListRowUI(container, index, text) {
    const div = document.createElement('div');
    div.className = 'list-row';
    // Textareaã«å¤‰æ›´ã—ã€valueãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å€¤ã‚’ã‚»ãƒƒãƒˆ
    div.innerHTML = `
        <div class="list-idx">${index+1}</div>
        <textarea class="list-input" rows="1"></textarea>
        <div class="list-del" onclick="this.parentElement.remove()">ğŸ—‘</div>
    `;
    div.querySelector('textarea').value = text;
    container.appendChild(div);
}

function addListRow() {
    const body = document.getElementById('listEditorBody');
    const idx = body.children.length;
    addListRowUI(body, idx, "");
    body.scrollTop = body.scrollHeight;
}

function saveListEdit() {
    const inputs = document.querySelectorAll('.list-input');
    labelData = [];
    inputs.forEach(input => {
        labelData.push(input.value); 
    });
    closeEditModal();
    render();
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// --- ãƒ‡ãƒ¼ã‚¿å‡¦ç† ---
function loadSample() {
    labelData = ["ç¾é‡‘", "å½“åº§\né é‡‘", "æ™®é€š\né é‡‘", "å—å–\næ‰‹å½¢", "å£²æ›é‡‘", "æ£šå¸\nè³‡ç”£", "å‰æ‰•\nè²»ç”¨", "å»ºç‰©", "æ¸›ä¾¡å„Ÿå´\nç´¯è¨ˆé¡"];
    render();
}
function clearAll() { labelData = []; render(); }

function loadCSV(input) {
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        labelData = parseCSV(e.target.result);
        render();
        input.value = '';
    };
    reader.readAsText(input.files[0]);
}
function parseCSV(text) {
    let list = [];
    text.split(/\r\n|\n|\r/).forEach(line => {
        const cols = line.split(',');
        let val = "";
        if (cols.length >= 2) val = cols[1];
        else if (cols.length === 1) val = cols[0];
        
        val = val.replace(/^"|"$/g, '').trim().replace(/\\n/g, '\n');
        if(val) list.push(val);
    });
    return list;
}

// --- æç”»ãƒ»ã‚µã‚¤ã‚ºè¨ˆç®— ---
function updateFontSize(element, text) {
    if (!text) { element.style.fontSize = `${BASE_SIZE_MM}mm`; return; }
    const lines = text.split(/\n/);
    let maxLen = 0;
    lines.forEach(line => { if (line.length > maxLen) maxLen = line.length; });
    let size = BASE_SIZE_MM;
    if (maxLen > 5) { size = BASE_SIZE_MM * 5 / maxLen; }
    element.style.fontSize = `${size}mm`;
}

function handleInput(e) {
    const target = e.target;
    const isPlus = target.classList.contains('text-plus');
    const text = target.innerText;
    
    const cell = target.closest('.cell');
    if(cell) {
        const idx = parseInt(cell.dataset.index);
        const startPos = parseInt(document.getElementById('startPos').value) || 0;
        const dataIdx = idx - startPos;
        if(dataIdx >= 0) {
            ensureArrayLength(dataIdx);
            labelData[dataIdx] = text;
        }
    }

    updateFontSize(target, text);
    if (document.getElementById('syncCheck').checked) {
        const pair = isPlus ? target.parentElement.querySelector('.text-minus') : target.parentElement.querySelector('.text-plus');
        if (pair) {
            pair.innerText = text;
            updateFontSize(pair, text);
        }
    }
}

function render() {
    const container = document.getElementById('previewArea');
    container.innerHTML = "";
    
    const startPos = parseInt(document.getElementById('startPos').value) || 0;
    const totalSlots = startPos + labelData.length;
    const pageCount = Math.max(1, Math.ceil(totalSlots / itemsPerPage));
    
    for (let p = 0; p < pageCount; p++) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        const grid = document.createElement('div');
        grid.className = 'grid-container';
        
        for (let i = 0; i < itemsPerPage; i++) {
            const globalIdx = p * itemsPerPage + i;
            
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = globalIdx;
            cell.addEventListener('contextmenu', (e) => showContextMenu(e, globalIdx));

            let text = "";
            const dataIdx = globalIdx - startPos;
            if (dataIdx >= 0 && dataIdx < labelData.length) {
                text = labelData[dataIdx];
            }

            const anchor = document.createElement('div');
            anchor.className = 'center-axis';

            const textPlus = document.createElement('div');
            textPlus.className = 'label-text-wrapper text-plus';
            textPlus.contentEditable = true; 
            textPlus.innerText = text; 
            
            const textMinus = document.createElement('div');
            textMinus.className = 'label-text-wrapper text-minus';
            textMinus.contentEditable = true;
            textMinus.innerText = text;
            
            updateFontSize(textPlus, text);
            updateFontSize(textMinus, text);

            textPlus.addEventListener('input', handleInput);
            textMinus.addEventListener('input', handleInput);
            
            cell.onclick = function(e) {
                if (e.target === cell) textPlus.focus();
            };

            anchor.appendChild(textPlus);
            anchor.appendChild(textMinus);
            cell.appendChild(anchor);
            grid.appendChild(cell);
        }
        sheet.appendChild(grid);
        container.appendChild(sheet);
    }
}
</script>
</body>
</html>
