<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>封筒宛名印刷</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --env-width: 235mm;
            --env-height: 120mm;
        }

        body { font-family: 'Noto Serif JP', serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        /* 設定エリア */
        .no-print { 
            font-family: sans-serif;
            background: white; padding: 20px; border-radius: 8px; 
            max-width: 1100px; margin: 0 auto 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 6px; }
        .config-item { display: flex; align-items: center; gap: 10px; }
        
        /* テーブル設定 */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; font-family: sans-serif; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }
        input[type="text"] { width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        .btn-group { margin: 15px 0; display: flex; gap: 10px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .print-btn { background: #e74c3c; color: white; margin-left: auto; }
        .add-btn { background: #6c757d; color: white; }

        /* 印刷設定 */
        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .envelope {
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
            }
        }

        /* 封筒本体のスタイル */
        .envelope {
            background: white;
            position: relative;
            margin: 0 auto 20px;
            border: 1px dotted #ccc;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            overflow: hidden;
            color: black;
        }

        /* 長形3号サイズ */
        .size-cho3 { width: 235mm; height: 120mm; }
        /* 角形2号サイズ */
        .size-kaku2 { width: 332mm; height: 240mm; }

        @page { margin: 0; }
        .print-cho3 { size: 235mm 120mm; }
        .print-kaku2 { size: 332mm 240mm; }

        /* レイアウト：シール風（強弱を抑えた設定） */
        .zip-code { position: absolute; font-weight: 700; font-size: 18pt; letter-spacing: 4px; }
        .size-cho3 .zip-code { top: 15mm; left: 15mm; }
        .size-kaku2 .zip-code { top: 25mm; left: 25mm; font-size: 24pt; }

        .address-box { position: absolute; width: 80%; line-height: 1.5; }
        .size-cho3 .address-box { top: 35mm; left: 20mm; font-size: 14pt; }
        .size-kaku2 .address-box { top: 55mm; left: 30mm; font-size: 20pt; }

        .name-box { position: absolute; display: flex; align-items: baseline; gap: 10px; }
        .size-cho3 .name-box { top: 70mm; left: 40mm; font-size: 18pt; }
        .size-kaku2 .name-box { top: 130mm; left: 60mm; font-size: 28pt; }
        
        .company-row { font-size: 0.8em; margin-bottom: 2mm; }
        .name-row { font-weight: 700; display: flex; align-items: baseline; gap: 8px; }
        .title-sub { font-size: 0.6em; font-weight: 400; margin-right: 5px; }
        .hon-sub { font-size: 0.8em; font-weight: 400; }

        /* 添え書き */
        .stamp-box {
            position: absolute;
            font-weight: 700;
            border: 2px solid;
            border-radius: 6px;
            padding: 4px 10px;
            white-space: nowrap;
        }
        .size-cho3 .stamp-box { bottom: 15mm; right: 15mm; font-size: 13pt; }
        .size-kaku2 .stamp-box { bottom: 30mm; right: 30mm; font-size: 18pt; }
        .stamp-blue { color: #003399; border-color: #003399; }
        .stamp-red { color: #cc0000; border-color: #cc0000; }
    </style>
</head>
<body class="print-cho3">

<div class="no-print">
    <h2>封筒宛名印刷</h2>
    
    <div class="config-grid">
        <div class="config-item">
            <strong>封筒サイズ:</strong>
            <label><input type="radio" name="envSize" value="cho3" checked onchange="changeSize('cho3')"> 長形3号</label>
            <label><input type="radio" name="envSize" value="kaku2" onchange="changeSize('kaku2')"> 角形2号</label>
        </div>
        <div class="config-item">
            <strong>添え書き:</strong>
            <input type="text" id="stampText" value="請求書在中" style="width:120px">
            <label><input type="radio" name="stampColor" value="blue" checked onchange="updatePreview()"> 青</label>
            <label><input type="radio" name="stampColor" value="red" onchange="updatePreview()"> 赤</label>
        </div>
    </div>

    <div class="btn-group">
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button onclick="document.getElementById('csvFile').click()" style="background:#3498db; color:white;">CSV読込</button>
        <button onclick="exportCSV()" style="background:#27ae60; color:white;">CSV保存</button>
        <button class="add-btn" onclick="addRow()">行追加</button>
        <button class="print-btn" onclick="window.print()">印刷する</button>
    </div>

    <table id="addressTable">
        <thead>
            <tr>
                <th style="width:80px">郵便番号</th>
                <th>住所1</th>
                <th>住所2</th>
                <th>会社名</th>
                <th>役職</th>
                <th>お名前</th>
                <th style="width:40px">敬称</th>
                <th style="width:30px"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="previewArea"></div>

<script>
    const tableBody = document.querySelector('#addressTable tbody');
    let currentSize = 'cho3';

    function changeSize(size) {
        currentSize = size;
        document.body.className = 'print-' + size;
        updatePreview();
    }

    function updatePreview() {
        const rows = tableBody.querySelectorAll('tr');
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = '';
        
        const stampText = document.getElementById('stampText').value;
        const stampColor = document.querySelector('input[name="stampColor"]:checked').value;

        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const d = {
                zip: inputs[0].value, a1: inputs[1].value, a2: inputs[2].value,
                comp: inputs[3].value, title: inputs[4].value, name: inputs[5].value, hon: inputs[6].value
            };

            const div = document.createElement('div');
            div.className = `envelope size-${currentSize}`;
            div.innerHTML = `
                <div class="zip-code">〒 ${d.zip}</div>
                <div class="address-box">
                    <div>${d.a1}</div>
                    <div style="margin-top:2mm">${d.a2}</div>
                </div>
                <div class="name-box">
                    <div>
                        ${d.comp ? `<div class="company-row">${d.comp}</div>` : ''}
                        <div class="name-row">
                            ${d.title ? `<span class="title-sub">${d.title}</span>` : ''}
                            ${d.name} <span class="hon-sub">${d.hon}</span>
                        </div>
                    </div>
                </div>
                ${stampText ? `<div class="stamp-box stamp-${stampColor}">${stampText}</div>` : ''}
            `;
            previewArea.appendChild(div);
        });
    }

    function addRow(data = {zip:'', a1:'', a2:'', comp:'', title:'', name:'', hon:'様'}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${data.zip}"></td>
            <td><input type="text" value="${data.a1}"></td>
            <td><input type="text" value="${data.a2}"></td>
            <td><input type="text" value="${data.comp}"></td>
            <td><input type="text" value="${data.title}"></td>
            <td><input type="text" value="${data.name}"></td>
            <td><input type="text" value="${data.hon}"></td>
            <td><button style="background:none; color:red; cursor:pointer;" onclick="this.parentElement.parentElement.remove(); updatePreview();">×</button></td>
        `;
        tableBody.appendChild(tr);
        tr.querySelectorAll('input').forEach(i => i.addEventListener('input', updatePreview));
        updatePreview();
    }

    // 初期データ
    addRow({zip:'123-4567', a1:'東京都千代田区1-2-3', a2:'ハイツサンプル 101', comp:'株式会社テスター', title:'部長', name:'山田 太郎', hon:'様'});

    // CSV読み込み (UTF-8-BOM / CP932対応)
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const uint8 = new Uint8Array(event.target.result);
            let text;
            try { text = new TextDecoder('utf-8', {fatal:true}).decode(uint8); }
            catch(e) { text = new TextDecoder('shift-jis').decode(uint8); }
            
            tableBody.innerHTML = '';
            text.split(/\r\n|\n|\r/).forEach((line, i) => {
                if(!line || i === 0 && line.includes('郵便番号')) return;
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"(.*)"$/, '$1').replace(/""/g,'"'));
                addRow({zip:c[0], a1:c[1], a2:c[2], comp:c[3], title:c[4], name:c[5], hon:c[6]||'様'});
            });
        };
        reader.readAsArrayBuffer(file);
    });

    function exportCSV() {
        let csv = "郵便番号,住所1,住所2,会社名,役職,名前,敬称\n";
        tableBody.querySelectorAll('tr').forEach(row => {
            csv += Array.from(row.querySelectorAll('input')).map(i => `"${i.value.replace(/"/g,'""')}"`).join(',') + "\n";
        });
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'address.csv'; a.click();
    }
    
    document.getElementById('stampText').addEventListener('input', updatePreview);
</script>
</body>
</html>
