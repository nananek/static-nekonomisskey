<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>封筒宛名印刷（上半分集中レイアウト）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Serif JP', serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        /* 設定エリア */
        .no-print { 
            font-family: sans-serif;
            background: white; padding: 20px; border-radius: 8px; 
            max-width: 1100px; margin: 0 auto 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 6px; }
        .config-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .config-label { font-weight: bold; min-width: 80px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; font-family: sans-serif; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }
        input[type="text"] { width: 95%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        .btn-group { margin: 15px 0; display: flex; gap: 10px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .print-btn { background: #e74c3c; color: white; margin-left: auto; }

        /* --- 印刷用設定 --- */
        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .envelope {
                page-break-after: always;
                border: none !important;
                box-shadow: none !important;
            }
            /* 反転設定 */
            .is-rotated .envelope {
                transform: rotate(180deg);
                transform-origin: center center;
            }
        }

        .envelope {
            background: white;
            position: relative;
            margin: 0 auto 20px;
            border: 1px dotted #ccc;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            overflow: hidden;
            color: black;
            box-sizing: border-box;
        }

        /* 縦置きサイズ */
        .size-cho3 { width: 120mm; height: 235mm; } /* 長3 */
        .size-kaku2 { width: 240mm; height: 332mm; } /* 角2 */

        @page { margin: 0; }

        /* --- 上半分集中レイアウト設定 --- */
        
        /* 1. 郵便番号：上から20mm */
        .zip-code { position: absolute; font-weight: 700; letter-spacing: 5px; top: 20mm; left: 15mm; }
        .size-cho3 .zip-code { font-size: 16pt; left: 15mm; }
        .size-kaku2 .zip-code { font-size: 22pt; left: 25mm; }

        /* 2. 住所：郵便番号のすぐ下 */
        .address-box { position: absolute; line-height: 1.5; word-break: break-all; }
        .size-cho3 .address-box { top: 38mm; left: 15mm; width: 90mm; font-size: 12pt; }
        .size-kaku2 .address-box { top: 45mm; left: 25mm; width: 190mm; font-size: 18pt; }

        /* 3. 名前：住所のすぐ下（上半分に収める） */
        .name-container {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        /* 長3(全高235mm)の上半分は117mm / 角2(全高332mm)の上半分は166mm */
        .size-cho3 .name-container { top: 68mm; }
        .size-kaku2 .name-container { top: 95mm; }

        .name-group-inner {
            display: inline-block;
            text-align: left;
            position: relative;
            padding-bottom: 12mm;
        }
        
        .company-row { font-size: 0.9em; margin-bottom: 2mm; white-space: nowrap; }
        .name-row { font-weight: 700; display: flex; align-items: baseline; white-space: nowrap; }
        
        .size-cho3 .company-row { font-size: 11pt; }
        .size-cho3 .name-row { font-size: 17pt; }
        .size-kaku2 .company-row { font-size: 16pt; }
        .size-kaku2 .name-row { font-size: 26pt; }

        .title-sub { font-size: 0.65em; font-weight: 400; margin-right: 0.5em; }
        .hon-sub { font-size: 0.8em; font-weight: 400; margin-left: 0.5em; }

        /* 在中スタンプ */
        .stamp-box {
            position: absolute;
            bottom: -3mm;
            right: -2mm;
            font-weight: 700;
            white-space: nowrap;
        }
        .stamp-border {
            border: 2px solid;
            border-radius: 6px;
            padding: 2px 8px;
        }
        .size-cho3 .stamp-box { font-size: 10pt; }
        .size-kaku2 .stamp-box { font-size: 14pt; }
        
        .stamp-blue { color: #003399; border-color: #003399; }
        .stamp-red { color: #cc0000; border-color: #cc0000; }
        .stamp-black { color: #000000; border-color: #000000; }
    </style>
</head>
<body class="print-cho3">

<div class="no-print">
    <h2>封筒宛名印刷（上半分集中・2cm余白版）</h2>
    
    <div class="config-grid">
        <div>
            <div class="config-item">
                <span class="config-label">サイズ:</span>
                <label><input type="radio" name="envSize" value="cho3" checked onchange="changeSize('cho3')"> 長形3号</label>
                <label><input type="radio" name="envSize" value="kaku2" onchange="changeSize('kaku2')"> 角形2号</label>
            </div>
            <div class="config-item" style="margin-top:10px;">
                <span class="config-label">出力方向:</span>
                <label style="cursor: pointer; color: #d9534f;">
                    <input type="checkbox" id="printRotate" onchange="updatePreview()"> 180度反転して印刷する
                </label>
            </div>
        </div>
        <div>
            <div class="config-item">
                <span class="config-label">在中スタンプ:</span>
                <input type="text" id="stampText" value="請求書在中" style="width:120px" oninput="updatePreview()">
                <label><input type="radio" name="stampColor" value="blue" checked onchange="updatePreview()"> 青</label>
                <label><input type="radio" name="stampColor" value="red" onchange="updatePreview()"> 赤</label>
                <label><input type="radio" name="stampColor" value="black" onchange="updatePreview()"> 黒</label>
            </div>
            <div class="config-item">
                <span class="config-label"></span>
                <label style="cursor: pointer;">
                    <input type="checkbox" id="stampHasBorder" checked onchange="updatePreview()"> 角丸の囲み枠をつける
                </label>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button onclick="document.getElementById('csvFile').click()" style="background:#3498db; color:white;">CSV読込</button>
        <button onclick="exportCSV()" style="background:#27ae60; color:white;">CSV保存</button>
        <button onclick="addRow()" style="background:#6c757d; color:white;">行追加</button>
        <button class="print-btn" onclick="window.print()">印刷を実行する</button>
    </div>

    <table id="addressTable">
        <thead>
            <tr>
                <th style="width:80px">郵便番号</th>
                <th>住所1</th>
                <th>住所2</th>
                <th>会社名</th>
                <th>役職</th>
                <th>お名前</th>
                <th style="width:50px">敬称</th>
                <th style="width:30px"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="previewArea"></div>

<script>
    const tableBody = document.querySelector('#addressTable tbody');
    let currentSize = 'cho3';

    function changeSize(size) {
        currentSize = size;
        document.body.className = 'print-' + size;
        updatePreview();
    }

    function updatePreview() {
        const rows = tableBody.querySelectorAll('tr');
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = '';
        
        if(document.getElementById('printRotate').checked) {
            previewArea.classList.add('is-rotated');
        } else {
            previewArea.classList.remove('is-rotated');
        }

        const stampText = document.getElementById('stampText').value;
        const stampColor = document.querySelector('input[name="stampColor"]:checked').value;
        const hasBorder = document.getElementById('stampHasBorder').checked;

        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const d = {
                zip: inputs[0].value.trim(), a1: inputs[1].value.trim(), a2: inputs[2].value.trim(),
                comp: inputs[3].value.trim(), title: inputs[4].value.trim(), name: inputs[5].value.trim(), hon: inputs[6].value.trim()
            };

            const div = document.createElement('div');
            div.className = `envelope size-${currentSize}`;
            
            const zipHtml = d.zip ? `<div class="zip-code">〒 ${d.zip}</div>` : '';
            
            let stampHtml = '';
            if (stampText) {
                const borderClass = hasBorder ? 'stamp-border' : '';
                stampHtml = `<div class="stamp-box stamp-${stampColor} ${borderClass}">${stampText}</div>`;
            }

            div.innerHTML = `
                ${zipHtml}
                <div class="address-box">
                    ${d.a1 ? `<div>${d.a1}</div>` : ''}
                    ${d.a2 ? `<div style="margin-top:1mm">${d.a2}</div>` : ''}
                </div>
                <div class="name-container">
                    <div class="name-group-inner">
                        ${d.comp ? `<div class="company-row">${d.comp}</div>` : ''}
                        <div class="name-row">
                            ${d.title ? `<span class="title-sub">${d.title}</span>` : ''}
                            ${d.name} ${d.name ? `<span class="hon-sub">${d.hon}</span>` : ''}
                        </div>
                        ${stampHtml}
                    </div>
                </div>
            `;
            previewArea.appendChild(div);
        });
    }

    function addRow(data = {zip:'', a1:'', a2:'', comp:'', title:'', name:'', hon:'様'}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${data.zip}"></td>
            <td><input type="text" value="${data.a1}"></td>
            <td><input type="text" value="${data.a2}"></td>
            <td><input type="text" value="${data.comp}"></td>
            <td><input type="text" value="${data.title}"></td>
            <td><input type="text" value="${data.name}"></td>
            <td><input type="text" value="${data.hon}"></td>
            <td><button style="background:none; color:red; cursor:pointer;" onclick="this.parentElement.parentElement.remove(); updatePreview();">×</button></td>
        `;
        tableBody.appendChild(tr);
        tr.querySelectorAll('input').forEach(i => i.addEventListener('input', updatePreview));
        updatePreview();
    }

    addRow({zip:'123-4567', a1:'東京都千代田区1-2-3', a2:'サンプルビル 4F', comp:'株式会社サンプル', title:'代表取締役', name:'山田 太郎', hon:'様'});

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const uint8 = new Uint8Array(event.target.result);
            let text;
            try { text = new TextDecoder('utf-8', {fatal:true}).decode(uint8); }
            catch(e) { text = new TextDecoder('shift-jis').decode(uint8); }
            tableBody.innerHTML = '';
            text.split(/\r\n|\n|\r/).forEach((line, i) => {
                if(!line || (i === 0 && (line.includes('郵便番号') || line.includes('住所')))) return;
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"(.*)"$/, '$1').replace(/""/g,'"'));
                addRow({zip:c[0]||'', a1:c[1]||'', a2:c[2]||'', comp:c[3]||'', title:c[4]||'', name:c[5]||'', hon:c[6]||'様'});
            });
            document.getElementById('csvFile').value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    function exportCSV() {
        let csv = "郵便番号,住所1,住所2,会社名,役職,名前,敬称\n";
        tableBody.querySelectorAll('tr').forEach(row => {
            csv += Array.from(row.querySelectorAll('input')).map(i => `"${i.value.replace(/"/g,'""')}"`).join(',') + "\n";
        });
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'address_list.csv'; a.click();
    }
</script>
</body>
</html>
