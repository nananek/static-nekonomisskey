<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>角形2号 宛名印刷（Noto Serif JP版）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* 全体のフォントを Noto Serif JP に設定 */
        body { 
            font-family: 'Noto Serif JP', serif; 
            background: #f4f7f6; 
            margin: 0; 
            padding: 20px; 
            color: #333; 
        }
        
        .no-print { 
            font-family: sans-serif; /* 設定エリアは操作性のためゴシック体 */
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            max-width: 1000px; 
            margin: 0 auto 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h3 { margin: 20px 0 10px; color: #2c3e50; font-size: 1.1rem;}
        
        /* 設定エリア */
        .stamp-settings { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .setting-row { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .setting-row label { cursor: pointer; }
        input[type="text"]#stampText { width: 200px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; font-family: sans-serif; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; }
        input[type="text"] { width: 92%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn-group { margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .import-btn { background: #3498db; color: white; }
        .export-btn { background: #27ae60; color: white; }
        .add-btn { background: #95a5a6; color: white; }
        .print-btn { background: #e74c3c; color: white; margin-left: auto; }

        /* 印刷レイアウト（角形2号: 332mm x 240mm） */
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .no-print { display: none; }
            .envelope {
                width: 332mm;
                height: 240mm;
                page-break-after: always;
                position: relative;
                box-sizing: border-box;
                overflow: hidden;
                border: none !important;
                box-shadow: none !important;
            }
            @page {
                size: 332mm 240mm;
                margin: 0;
            }
        }

        /* 封筒内配置 */
        .envelope {
            width: 332mm;
            height: 240mm;
            background: white;
            position: relative;
            margin: 0 auto 20px;
            border: 1px dotted #ccc; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            color: black;
        }

        /* 郵便番号は読み取り精度を考慮し、等幅フォントまたは少し太めに */
        .zip-code { 
            position: absolute; 
            top: 25mm; 
            left: 35mm; 
            font-size: 28pt; 
            letter-spacing: 8px; 
            font-weight: 700;
        }
        
        .address-box { position: absolute; top: 60mm; left: 40mm; width: 260mm; }
        .addr1 { font-size: 24pt; display: block; margin-bottom: 5mm; word-break: break-all; }
        .addr2 { font-size: 20pt; display: block; padding-left: 2em; word-break: break-all; }
        
        .name-box {
            position: absolute;
            top: 135mm;
            left: 50%;
            transform: translateX(-50%);
            width: 280mm;
            text-align: center;
        }
        .company { font-size: 20pt; display: block; margin-bottom: 8mm; }
        .title-name { 
            font-size: 38pt; 
            font-weight: 700; 
            display: flex; 
            justify-content: center; 
            align-items: baseline; 
            gap: 15px; 
        }
        .title { font-size: 18pt; font-weight: 400; }
        .honorific { font-size: 28pt; font-weight: 400; }

        .stamp-box {
            position: absolute;
            bottom: 30mm;
            right: 30mm;
            font-size: 20pt;
            font-weight: 700;
            white-space: nowrap;
        }
        .stamp-blue { color: #003399; border-color: #003399; }
        .stamp-red { color: #cc0000; border-color: #cc0000; }
        .stamp-border {
            border: 3px solid;
            border-radius: 12px;
            padding: 5px 15px;
        }
    </style>
</head>
<body>

<div class="no-print">
    <h2>角形2号 宛名印刷（Noto Serif JP）</h2>
    
    <div class="stamp-settings">
        <h3>添え書き設定 (封筒右下)</h3>
        <div class="setting-row">
            <label>文言: <input type="text" id="stampText" value="請求書在中"></label>
            <span>色:</span>
            <label><input type="radio" name="stampColor" value="blue" checked> 青</label>
            <label><input type="radio" name="stampColor" value="red"> 赤</label>
            <span style="margin-left: 10px; border-left:1px solid #ccc; padding-left:10px;">枠線:</span>
            <label><input type="checkbox" id="stampBorder" checked> 角丸枠</label>
        </div>
    </div>
    
    <div class="btn-group">
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button class="import-btn" onclick="document.getElementById('csvFile').click()">CSV読込 (SJIS/UTF8)</button>
        <button class="export-btn" onclick="exportCSV()">CSV保存 (Excel用BOM付)</button>
        <button class="add-btn" onclick="addRow()">宛名追加</button>
        <button class="print-btn" onclick="window.print()">印刷開始</button>
    </div>

    <table id="addressTable">
        <thead>
            <tr>
                <th style="width: 90px;">郵便番号</th>
                <th>住所1</th>
                <th>住所2</th>
                <th>会社名</th>
                <th style="width: 80px;">役職</th>
                <th>お名前</th>
                <th style="width: 50px;">敬称</th>
                <th style="width: 30px;"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="previewArea"></div>

<script>
    const tableBody = document.querySelector('#addressTable tbody');
    const previewArea = document.getElementById('previewArea');
    const stampTextInput = document.getElementById('stampText');
    const stampColorInputs = document.querySelectorAll('input[name="stampColor"]');
    const stampBorderInput = document.getElementById('stampBorder');

    const defaultData = {zip: '100-0001', a1: '東京都千代田区千代田1-1', a2: 'サンプルビル 3F', comp: '株式会社サンプル', title: '代表取締役', name: '山田 太郎', hon: '様'};

    function updatePreview() {
        const rows = tableBody.querySelectorAll('tr');
        previewArea.innerHTML = '';
        const stampText = stampTextInput.value;
        const stampColor = document.querySelector('input[name="stampColor"]:checked').value;
        const hasBorder = stampBorderInput.checked;

        let stampHtml = '';
        if (stampText) {
            const colorClass = `stamp-${stampColor}`;
            const borderClass = hasBorder ? 'stamp-border' : '';
            stampHtml = `<div class="stamp-box ${colorClass} ${borderClass}">${stampText}</div>`;
        }
        
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const data = {
                zip: inputs[0].value, a1: inputs[1].value, a2: inputs[2].value,
                comp: inputs[3].value, title: inputs[4].value, name: inputs[5].value, hon: inputs[6].value
            };

            const div = document.createElement('div');
            div.className = 'envelope';
            div.innerHTML = `
                <div class="zip-code">〒 ${data.zip}</div>
                <div class="address-box">
                    <span class="addr1">${data.a1}</span>
                    <span class="addr2">${data.a2}</span>
                </div>
                <div class="name-box">
                    ${data.comp ? `<span class="company">${data.comp}</span>` : ''}
                    <div class="title-name">
                        ${data.title ? `<span class="title">${data.title}</span>` : ''}
                        <span>${data.name}</span>
                        <span class="honorific">${data.hon}</span>
                    </div>
                </div>
                ${stampHtml}
            `;
            previewArea.appendChild(div);
        });
    }

    function addRow(data = {zip:'', a1:'', a2:'', comp:'', title:'', name:'', hon:'様'}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${data.zip}"></td>
            <td><input type="text" value="${data.a1}"></td>
            <td><input type="text" value="${data.a2}"></td>
            <td><input type="text" value="${data.comp}"></td>
            <td><input type="text" value="${data.title}"></td>
            <td><input type="text" value="${data.name}"></td>
            <td><input type="text" value="${data.hon}"></td>
            <td><button style="background:none; color:#999; cursor:pointer;" onclick="this.parentElement.parentElement.remove(); updatePreview();">×</button></td>
        `;
        tableBody.appendChild(tr);
        tr.querySelectorAll('input').forEach(input => input.addEventListener('input', updatePreview));
        updatePreview();
    }

    addRow(defaultData);
    stampTextInput.addEventListener('input', updatePreview);
    stampColorInputs.forEach(input => input.addEventListener('change', updatePreview));
    stampBorderInput.addEventListener('change', updatePreview);

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const buffer = event.target.result;
            const uint8Array = new Uint8Array(buffer);
            let text;
            try {
                const decoder = new TextDecoder('utf-8', { fatal: true });
                text = decoder.decode(uint8Array);
            } catch (e) {
                const decoder = new TextDecoder('shift-jis');
                text = decoder.decode(uint8Array);
            }
            const lines = text.split(/\r\n|\n|\r/);
            if (lines.length > 0) {
                tableBody.innerHTML = '';
                lines.forEach((line, index) => {
                    if (index === 0 && (line.includes('郵便番号') || line.includes('名前'))) return;
                    if (line.trim() === '') return;
                    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"(.*)"$/, '$1').replace(/""/g, '"'));
                    addRow({
                        zip: cols[0] || '', a1: cols[1] || '', a2: cols[2] || '',
                        comp: cols[3] || '', title: cols[4] || '', name: cols[5] || '', hon: cols[6] || '様'
                    });
                });
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function exportCSV() {
        let csv = "郵便番号,住所1,住所2,会社名,役職,名前,敬称\n";
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = Array.from(inputs).map(i => `"${i.value.replace(/"/g, '""')}"`);
            csv += rowData.join(',') + "\n";
        });
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `宛名リスト_${new Date().getTime()}.csv`;
        link.click();
    }
</script>

</body>
</html>
