<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ©ãƒ™ãƒ«ä½œæˆ (ãƒ¢ãƒ¼ãƒ€ãƒ«è¨­å®šç‰ˆ)</title>
<style>
    /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    body { font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif; background: #f2f4f8; margin: 0; padding: 20px; color: #333; }
    
    /* --- æ“ä½œãƒ‘ãƒãƒ« --- */
    #controls {
        background: white; padding: 20px; border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 900px; margin: 0 auto 30px;
    }
    .panel-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .panel-group:last-child { margin-bottom: 0; }
    
    h2 { margin: 0; font-size: 1.1rem; color: #444; display: flex; align-items: center; gap: 8px; }
    
    /* ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ›å‘¨ã‚Š */
    button { padding: 10px 16px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
    button:active { transform: scale(0.98); }
    .btn-primary { background: #007bff; color: white; }
    .btn-outline { background: white; border: 1px solid #ccc; color: #444; }
    .btn-success { background: #28a745; color: white; }
    
    input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (CSVè¨­å®šç”»é¢) --- */
    #modalOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(2px);
    }
    #modalContent {
        background: white; width: 90%; max-width: 600px; max-height: 80vh;
        border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    #modalHeader { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-wrapper { overflow: auto; border: 1px solid #eee; margin-bottom: 15px; max-height: 300px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    
    /* åˆ—é¸æŠã®å¼·èª¿ */
    th.selectable-col { cursor: pointer; background: #f8f9fa; position: sticky; top: 0; z-index: 1; }
    th.selectable-col:hover { background: #e2e6ea; }
    th.selected-col { background: #e7f1ff; border-bottom: 2px solid #007bff; color: #0056b3; }
    td.selected-col-cell { background: #f0f7ff; font-weight: bold; }
    
    /* è¦‹å‡ºã—è¡Œã®æ‰±ã„ */
    tr.is-header { opacity: 0.6; background: #f9f9f9; }

    /* --- å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (ç”¨ç´™) --- */
    @page { size: A4; margin: 0; }
    
    .sheet {
        width: 210mm; height: 297mm; background: white; margin: 0 auto 30px;
        display: grid;
        /* ãƒ‹ãƒãƒãƒ³ ãƒã‚¤ã‚¿ãƒƒã‚¯ A4ç‰ˆ ä¸­ã‚µã‚¤ã‚º (ML-132) æƒ³å®šè¨­å®š */
        padding-top: 19mm; padding-left: 15mm;
        grid-template-columns: repeat(9, 23mm);
        grid-template-rows: repeat(8, 29mm);
        gap: 0mm; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1);
        page-break-after: always;
    }

    .label {
        width: 23mm; height: 29mm;
        display: flex; justify-content: center; align-items: center;
        writing-mode: vertical-rl; text-orientation: upright;
        font-family: "Hiragino Mincho ProN", "MS Mincho", serif;
        font-size: 10.5pt; line-height: 1.1;
        border: 0.5px dotted #ccc; /* ç”»é¢ç¢ºèªç”¨ */
        box-sizing: border-box; overflow: hidden;
    }
    .label.empty-slot { background: #f5f5f5; }

    /* --- å°åˆ·ãƒ¢ãƒ¼ãƒ‰ --- */
    @media print {
        body { background: white; padding: 0; }
        #controls, #modalOverlay { display: none !important; }
        .sheet { margin: 0; box-shadow: none; }
        .label { border: none; }
        .label.empty-slot { background: none; }
    }
</style>
</head>
<body>

<div id="controls">
    <div class="panel-group">
        <h2>ğŸ“‹ ãƒ©ãƒ™ãƒ«å°åˆ·</h2>
        <div>
            <button class="btn-outline" onclick="downloadSampleCSV()">ã‚µãƒ³ãƒ—ãƒ«CSVä¿å­˜</button>
            <button class="btn-primary" onclick="document.getElementById('csvInput').click()">CSVã‚’èª­ã¿è¾¼ã‚€</button>
            <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="openModal(this)">
        </div>
    </div>

    <div class="panel-group" style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <label>é–‹å§‹ä½ç½®: <input type="number" id="startPos" value="1" min="1" max="72" onchange="renderLabels()"></label>
            <span style="font-size: 0.8rem; color: #666;">â€»ä½¿ã„ã‹ã‘ã®ã‚·ãƒ¼ãƒˆç”¨ (1ã€œ72)</span>
        </div>
        <button class="btn-success" onclick="window.print()">ğŸ–¨ å°åˆ·ã™ã‚‹</button>
    </div>
</div>

<div id="printArea"></div>

<div id="modalOverlay">
    <div id="modalContent">
        <div id="modalHeader">CSVèª­ã¿è¾¼ã¿è¨­å®š</div>
        
        <div style="margin-bottom: 10px;">
            <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="hasHeader" checked onchange="updateModalTable()">
                1è¡Œç›®ã¯è¦‹å‡ºã—ï¼ˆèª­ã¿é£›ã°ã™ï¼‰
            </label>
        </div>
        
        <p style="font-size: 0.8rem; color: #666; margin-top:0;">â–¼ ç§‘ç›®åã®åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
        
        <div class="table-wrapper">
            <table id="previewTable"></table>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: auto;">
            <button class="btn-outline" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-primary" onclick="confirmImport()">æ±ºå®šã—ã¦è¡¨ç¤º</button>
        </div>
    </div>
</div>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
let rawCSVData = []; // CSVã®å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ã®é…åˆ—ï¼‰
let selectedColIndex = 1; // é¸æŠä¸­ã®åˆ—ç•ªå· (0å§‹ã¾ã‚Š)

// --- åˆæœŸåŒ–: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º ---
window.onload = function() {
    // ç”»é¢ã‚’é–‹ã„ãŸã¨ãã¯ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤ºã—ã¦ãŠã
    const sample = generateSampleData();
    rawCSVData = parseCSV(sample);
    selectedColIndex = 1;
    renderLabels();
};

// --- 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -> ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º ---
function openModal(input) {
    if (!input.files[0]) return;

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    const reader = new FileReader();
    reader.onload = function(e) {
        // Shift_JISå¯¾ç­–ç­‰ã¯ã—ã¦ã„ãªã„ç°¡æ˜“ç‰ˆã ãŒã€UTF-8ãªã‚‰å‹•ã
        // æ–‡å­—åŒ–ã‘å¯¾å¿œãŒå¿…è¦ãªã‚‰ encoding.js ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹ãŒä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
        rawCSVData = parseCSV(e.target.result);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        document.getElementById('modalOverlay').style.display = 'flex';
        updateModalTable();
        
        // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
        input.value = '';
    };
    // â€»Excelã®CSVã‚’æƒ³å®šã—ã¦Shift_JISãƒˆãƒ©ã‚¤ã€ã ã‚ãªã‚‰UTF-8ã¨ã„ã†åˆ¤å®šã¯è¤‡é›‘ãªã®ã§
    // ã“ã“ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–æŒ™å‹•ã«ä»»ã›ã‚‹ï¼ˆæœ€è¿‘ã®ã‚¹ãƒãƒ›ã¯UTF-8æ¨å¥¨ï¼‰
    reader.readAsText(input.files[0]);
}

function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
}

// --- 2. ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ---
function updateModalTable() {
    const table = document.getElementById('previewTable');
    table.innerHTML = "";
    
    const hasHeader = document.getElementById('hasHeader').checked;
    const maxPreviewRows = Math.min(rawCSVData.length, 10); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æœ€å¤§10è¡Œ
    
    // ãƒ˜ãƒƒãƒ€è¡Œ (ã‚¯ãƒªãƒƒã‚¯ç”¨)
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    // ãƒ‡ãƒ¼ã‚¿å†…ã§æœ€ã‚‚åˆ—æ•°ãŒå¤šã„è¡Œã‚’æ¢ã™
    const colCount = rawCSVData.reduce((max, row) => Math.max(max, row.length), 0);

    for (let c = 0; c < colCount; c++) {
        const th = document.createElement('th');
        th.className = 'selectable-col';
        if (c === selectedColIndex) th.classList.add('selected-col');
        th.textContent = `åˆ— ${c + 1}`;
        th.onclick = () => {
            selectedColIndex = c;
            updateModalTable(); // å†æç”»ã—ã¦é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        };
        headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // ãƒœãƒ‡ã‚£è¡Œ
    const tbody = document.createElement('tbody');
    for (let r = 0; r < maxPreviewRows; r++) {
        const tr = document.createElement('tr');
        if (r === 0 && hasHeader) tr.className = 'is-header';
        
        for (let c = 0; c < colCount; c++) {
            const td = document.createElement('td');
            td.textContent = rawCSVData[r][c] || "";
            if (c === selectedColIndex) td.classList.add('selected-col-cell');
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
    table.appendChild(tbody);
}

// --- 3. æ±ºå®šå‡¦ç† ---
function confirmImport() {
    renderLabels();
    closeModal();
}

// --- 4. ãƒ©ãƒ™ãƒ«æç”»å‡¦ç† ---
function renderLabels() {
    const printArea = document.getElementById('printArea');
    printArea.innerHTML = "";
    
    const startPos = parseInt(document.getElementById('startPos').value) - 1;
    const hasHeader = document.getElementById('hasHeader').checked;

    // ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    let list = [];
    rawCSVData.forEach((row, index) => {
        if (hasHeader && index === 0) return; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚­ãƒƒãƒ—
        if (row[selectedColIndex]) {
            list.push(row[selectedColIndex].trim());
        }
    });
    // ç©ºç™½é™¤å»
    list = list.filter(item => item !== "");

    // ã‚·ãƒ¼ãƒˆç”Ÿæˆãƒ«ãƒ¼ãƒ—
    const itemsPerPage = 72; // 9x8
    const totalSlots = startPos + list.length;
    let sheetCount = Math.ceil(totalSlots / itemsPerPage) || 1;
    
    let dataIndex = 0;

    for (let s = 0; s < sheetCount; s++) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        
        for (let i = 0; i < itemsPerPage; i++) {
            const currentSlot = (s * itemsPerPage) + i;
            const div = document.createElement('div');
            
            if (currentSlot < startPos) {
                // ä½¿ã„ã•ã—éƒ¨åˆ†
                div.className = 'label empty-slot';
            } else if (dataIndex < list.length) {
                // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
                div.className = 'label';
                const text = list[dataIndex];
                div.textContent = text;
                
                // é•·ä½“å‡¦ç†
                if (text.length >= 6) {
                    div.style.fontSize = "8.5pt";
                    div.style.letterSpacing = "-1px";
                }
                dataIndex++;
            } else {
                // ä½™ç™½
                div.className = 'label';
            }
            sheet.appendChild(div);
        }
        printArea.appendChild(sheet);
    }
}

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: CSVãƒ‘ãƒ¼ã‚¹ (ç°¡æ˜“ç‰ˆ) ---
function parseCSV(text) {
    // æ”¹è¡Œã§åˆ†å‰²ã—ã€ã‚«ãƒ³ãƒã§åˆ†å‰²ã™ã‚‹ã ã‘ã®ç°¡æ˜“å‡¦ç†
    // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ã‚«ãƒ³ãƒå¯¾å¿œãªã©æœ¬æ ¼çš„ãªã‚‚ã®ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã ãŒ
    // ã“ã“ã§ã¯ã€ŒExcelã‹ã‚‰åãå‡ºã•ã‚ŒãŸæ¨™æº–çš„ãªCSVã€ã‚’æƒ³å®š
    return text.split(/\r\n|\n/).map(line => {
        // å…ˆé ­ãƒ»æœ«å°¾ã®"ã‚’å–ã‚Šé™¤ãç°¡æ˜“å‡¦ç†
        return line.split(',').map(cell => cell.replace(/^"|"$/g, ''));
    }).filter(row => row.length > 1 || (row.length === 1 && row[0] !== ""));
}

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
function generateSampleData() {
    return `ID,ç§‘ç›®å,å‚™è€ƒ
101,ç¾é‡‘,
102,å½“åº§é é‡‘,
103,æ™®é€šé é‡‘,
104,å£²æ›é‡‘,
105,å•†å“,
106,å‰æ‰•è²»ç”¨,
107,å»ºç‰©,
108,å‚™å“,
109,åœŸåœ°,
201,æ”¯æ‰•æ‰‹å½¢,
202,è²·æ›é‡‘,
203,æœªæ‰•é‡‘,
204,é ã‚Šé‡‘,
205,å€Ÿå…¥é‡‘,
301,è³‡æœ¬é‡‘,
401,å£²ä¸Šé«˜,
501,ä»•å…¥é«˜,
502,çµ¦æ–™æ‰‹å½“,
503,æ—…è²»äº¤é€šè²»,
504,æ¶ˆè€—å“è²»,
505,é€šä¿¡è²»,
506,ç§Ÿç¨å…¬èª²,
507,æ¸›ä¾¡å„Ÿå´è²»,`;
}

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚µãƒ³ãƒ—ãƒ«CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
function downloadSampleCSV() {
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // UTF-8 BOM
    const content = generateSampleData();
    const blob = new Blob([bom, content], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_accounts.csv';
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
